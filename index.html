<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Suivi PSG</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Suivi PSG">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgZmlsbD0iIzAwNDE3MCIvPjx0ZXh0IHg9IjkwIiB5PSI5MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9ImNlbnRyYWwiPlBTRzwvdGV4dD48L3N2Zz4=">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #004170, #ff0000);
            color: white;
            padding: 20px 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 22px;
            margin: 0 0 8px 0;
            line-height: 1.2;
        }
        .header p {
            font-size: 14px;
            margin: 0;
            opacity: 0.9;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #004170, #0066aa);
            color: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
            line-height: 1;
        }
        .stat-card div:last-child {
            font-size: 11px;
            opacity: 0.9;
            line-height: 1.2;
        }
        
        /* Table responsive pour mobile */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            min-width: 800px; /* Assure que le tableau ne se d√©forme pas */
            border-collapse: collapse;
            background: white;
            font-size: 12px;
        }
        
        th {
            background: linear-gradient(135deg, #004170, #0066aa);
            color: white;
            padding: 12px 6px;
            text-align: center;
            font-weight: bold;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 8px 4px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
            text-align: center;
        }
        
        /* Inputs optimis√©s pour mobile */
        input, select {
            width: 100%;
            padding: 8px 4px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
            background: white;
        }
        
        input[type="date"] {
            min-width: 120px;
        }
        
        input[type="number"] {
            min-width: 80px;
        }
        
        select {
            min-width: 100px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px;
        }
        
        /* Boutons optimis√©s pour mobile */
        .add-match {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 15px;
            font-size: 16px;
            box-shadow: 0 3px 12px rgba(5, 150, 105, 0.3);
            touch-action: manipulation;
        }
        
        .controls-row {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .controls-row button {
            flex: 1;
            padding: 8px 2px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 9px;
            font-weight: 500;
            cursor: pointer;
            touch-action: manipulation;
            min-height: 36px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .export-btn { background: #004170; }
        .import-btn { background: #059669; }
        .clear-btn { background: #dc2626; }
        
        /* L√©gende adapt√©e mobile */
        .legend {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-color {
            width: 4px;
            height: 20px;
            border-radius: 2px;
        }
        
        /* Section analyse optimis√©e */
        .analysis-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .analysis-section h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #004170;
        }
        
        .analysis-section p {
            margin: 8px 0;
        }
        
        /* Notifications mobiles */
        .notification {
            position: fixed !important;
            top: 60px !important;
            left: 10px !important;
            right: 10px !important;
            background: #059669;
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            font-size: 14px;
            text-align: center;
        }
        
        /* Am√©lioration du contraste et lisibilit√© */
        .euro::after {
            content: " ‚Ç¨";
            font-weight: normal;
        }
        
        .revenue-positive { 
            color: #059669; 
            font-weight: bold; 
        }
        
        .revenue-negative { 
            color: #dc2626; 
            font-weight: bold; 
        }
        
        /* Bouton suppression optimis√© */
        td button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            min-width: 32px;
            min-height: 32px;
            touch-action: manipulation;
        }
        
        /* Am√©lioration de l'accessibilit√© tactile */
        input:focus, select:focus, button:focus {
            outline: 2px solid #004170;
            outline-offset: 2px;
        }
        
        /* Animation pour le feedback tactile */
        button:active {
            transform: scale(0.98);
            transition: transform 0.1s;
        }
        
        /* Masquer le scroll horizontal disgracieux */
        .table-container::-webkit-scrollbar {
            height: 4px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #004170;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¥üîµ SUIVI ABONNEMENT PSG 2024-2025</h1>
            <p>Co√ªt initial: 1680‚Ç¨ | Suivi des reventes et rentabilit√©</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">0‚Ç¨</div>
                <div>Revenus totaux</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="netResult">-1680‚Ç¨</div>
                <div>R√©sultat net</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="averagePrice">0‚Ç¨</div>
                <div>Prix moyen/vente</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="attendedMatches">0</div>
                <div>Matchs assist√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="soldMatches">0</div>
                <div>Places vendues</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lostMatches">0</div>
                <div>Places perdues</div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ec4899;"></div>
                <span>Ligue 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #1e3a8a;"></div>
                <span>Ligue des Champions</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #dc2626;"></div>
                <span>Coupe de France</span>
            </div>
        </div>

        <button class="add-match" onclick="addMatch()">‚ûï Ajouter un match</button>
        
        <div class="controls-row">
            <button class="export-btn" onclick="exportData()">üì§ Exporter</button>
            <button class="import-btn" onclick="importData()">üì• Importer</button>
            <button class="clear-btn" onclick="clearData()">üóëÔ∏è Reset</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
        </div>

        <div class="table-container">
            <table id="matchTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Adversaire</th>
                        <th>Comp√©tition</th>
                        <th>Prix vente</th>
                        <th>Assist√©</th>
                        <th>Revenus</th>
                        <th>‚ùå</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les matchs seront ajout√©s dynamiquement -->
                </tbody>
            </table>
        </div>

        <div class="analysis-section">
            <h3>üìä Analyse de rentabilit√©</h3>
            <div id="analysis">
                <p>Ajoutez des matchs pour voir l'analyse d√©taill√©e de votre abonnement.</p>
            </div>
        </div>
    </div>

    <script>
        let matches = [];
        let matchCounter = 0;

        // Fonction pour sauvegarder les donn√©es
        function saveData() {
            const tableData = [];
            const rows = document.querySelectorAll('#matchTable tbody tr');
            
            rows.forEach((row, index) => {
                const matchId = row.id.split('-')[1];
                if (matchId) {
                    const data = {
                        id: matchId,
                        date: document.getElementById(`date-${matchId}`)?.value || '',
                        opponent: document.getElementById(`opponent-${matchId}`)?.value || '',
                        competition: document.getElementById(`competition-${matchId}`)?.value || '',
                        price: document.getElementById(`price-${matchId}`)?.value || 0,
                        attended: document.getElementById(`attended-${matchId}`)?.value || ''
                    };
                    tableData.push(data);
                }
            });
            
            const saveObject = {
                matches: tableData,
                counter: matchCounter,
                lastSave: new Date().toISOString()
            };
            
            localStorage.setItem('psg_subscription_data', JSON.stringify(saveObject));
            
            // Afficher confirmation de sauvegarde
            showSaveConfirmation();
        }

        // Fonction pour charger les donn√©es
        function loadData() {
            const saved = localStorage.getItem('psg_subscription_data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    matchCounter = data.counter || 0;
                    
                    // Recr√©er les matchs sauvegard√©s
                    data.matches.forEach(match => {
                        addMatchWithData(match);
                    });
                    
                    updateStats();
                    updateAnalysis();
                    
                    // Afficher message de chargement
                    showLoadConfirmation(data.lastSave);
                } catch (e) {
                    console.error('Erreur lors du chargement des donn√©es:', e);
                }
            }
        }

        // Fonction pour ajouter un match avec donn√©es existantes
        function addMatchWithData(matchData) {
            const tableBody = document.querySelector('#matchTable tbody');
            const row = document.createElement('tr');
            const id = matchData.id;
            row.id = `match-${id}`;
            
            row.innerHTML = `
                <td><input type="date" onchange="updateMatch(${id}); saveData();" id="date-${id}" value="${matchData.date}"></td>
                <td><input type="text" placeholder="Ex: Marseille" onchange="updateMatch(${id}); saveData();" id="opponent-${id}" value="${matchData.opponent}"></td>
                <td>
                    <select onchange="updateMatch(${id}); saveData();" id="competition-${id}">
                        <option value="">S√©lectionner</option>
                        <option value="Ligue 1" ${matchData.competition === 'Ligue 1' ? 'selected' : ''}>Ligue 1</option>
                        <option value="Ligue des Champions" ${matchData.competition === 'Ligue des Champions' ? 'selected' : ''}>Ligue des Champions</option>
                        <option value="Coupe de France" ${matchData.competition === 'Coupe de France' ? 'selected' : ''}>Coupe de France</option>
                    </select>
                </td>
                <td><input type="number" placeholder="0" onchange="updateMatch(${id}); saveData();" id="price-${id}" value="${matchData.price}"></td>
                <td>
                    <select onchange="updateMatch(${id}); saveData();" id="attended-${id}">
                        <option value="">-</option>
                        <option value="Oui" ${matchData.attended === 'Oui' ? 'selected' : ''}>Oui (0‚Ç¨)</option>
                        <option value="Non" ${matchData.attended === 'Non' ? 'selected' : ''}>Non (vendu)</option>
                    </select>
                </td>
                <td class="euro" id="revenue-${id}">0</td>
                <td><button onclick="removeMatch(${id}); saveData();">‚ùå</button></td>
            `;
            
            tableBody.appendChild(row);
            updateRowStyle(id);
            updateMatch(id);
            
            // Force la mise √† jour des stats apr√®s ajout
            setTimeout(() => {
                updateStats();
                updateAnalysis();
            }, 200);
        }

        function showSaveConfirmation() {
            const notification = document.createElement('div');
            notification.innerHTML = 'üíæ Sauvegard√© !';
            notification.className = 'notification';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 1500);
        }

        function showLoadConfirmation(lastSave) {
            const date = new Date(lastSave).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            const notification = document.createElement('div');
            notification.innerHTML = `üìÇ Donn√©es charg√©es (${date})`;
            notification.className = 'notification';
            notification.style.background = '#004170';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2500);
        }

        function addMatch() {
            matchCounter++;
            const tableBody = document.querySelector('#matchTable tbody');
            const row = document.createElement('tr');
            row.id = `match-${matchCounter}`;
            
            row.innerHTML = `
                <td><input type="date" onchange="updateMatch(${matchCounter}); saveData();" id="date-${matchCounter}"></td>
                <td><input type="text" placeholder="Ex: Marseille" onchange="updateMatch(${matchCounter}); saveData();" id="opponent-${matchCounter}"></td>
                <td>
                    <select onchange="updateMatch(${matchCounter}); saveData();" id="competition-${matchCounter}">
                        <option value="">S√©lectionner</option>
                        <option value="Ligue 1">Ligue 1</option>
                        <option value="Ligue des Champions">Ligue des Champions</option>
                        <option value="Coupe de France">Coupe de France</option>
                    </select>
                </td>
                <td><input type="number" placeholder="0" onchange="updateMatch(${matchCounter}); saveData();" id="price-${matchCounter}"></td>
                <td>
                    <select onchange="updateMatch(${matchCounter}); saveData();" id="attended-${matchCounter}">
                        <option value="">-</option>
                        <option value="Oui">Oui (0‚Ç¨)</option>
                        <option value="Non">Non (vendu)</option>
                    </select>
                </td>
                <td class="euro" id="revenue-${matchCounter}">0</td>
                <td><button onclick="removeMatch(${matchCounter}); saveData();">‚ùå</button></td>
            `;
            
            tableBody.appendChild(row);
            updateRowStyle(matchCounter);
            saveData(); // Sauvegarder apr√®s ajout
            
            // Force la mise √† jour imm√©diate des stats
            setTimeout(() => {
                updateStats();
                updateAnalysis();
            }, 100);
        }

        function updateMatch(matchId) {
            const date = document.getElementById(`date-${matchId}`).value;
            const opponent = document.getElementById(`opponent-${matchId}`).value;
            const competition = document.getElementById(`competition-${matchId}`).value;
            const price = parseFloat(document.getElementById(`price-${matchId}`).value) || 0;
            const attended = document.getElementById(`attended-${matchId}`).value;
            
            const revenue = attended === 'Oui' ? 0 : price;
            document.getElementById(`revenue-${matchId}`).textContent = revenue;
            
            // Mise √† jour du style de la ligne
            updateRowStyle(matchId);
            
            // Mise √† jour imm√©diate des statistiques et de l'analyse
            setTimeout(() => {
                updateStats();
                updateAnalysis();
            }, 100);
        }

        function updateRowStyle(matchId) {
            const row = document.getElementById(`match-${matchId}`);
            const competition = document.getElementById(`competition-${matchId}`).value;
            const attended = document.getElementById(`attended-${matchId}`).value;
            
            // Retirer les classes existantes
            row.classList.remove('match-ligue1', 'match-ucl', 'match-coupe', 'attended-yes', 'attended-no');
            row.style.background = ''; // Reset du background
            
            // Ajouter la classe selon la comp√©tition avec fond color√©
            if (competition === 'Ligue 1') {
                row.classList.add('match-ligue1');
                row.style.background = 'rgba(236, 72, 153, 0.1)'; // Rose
                row.style.borderLeft = '4px solid #ec4899';
            }
            if (competition === 'Ligue des Champions') {
                row.classList.add('match-ucl');
                row.style.background = 'rgba(30, 58, 138, 0.1)';
                row.style.borderLeft = '4px solid #1e3a8a';
            }
            if (competition === 'Coupe de France') {
                row.classList.add('match-coupe');
                row.style.background = 'rgba(220, 38, 38, 0.1)';
                row.style.borderLeft = '4px solid #dc2626';
            }
            
            // Ajouter une surbrillance selon la pr√©sence (par-dessus la couleur de comp√©tition)
            if (attended === 'Oui') {
                row.classList.add('attended-yes');
                // Ajouter une l√©g√®re surbrillance verte pour les matchs assist√©s
                if (competition) {
                    const currentBg = row.style.background;
                    row.style.background = `${currentBg}, rgba(34, 197, 94, 0.05)`;
                } else {
                    row.style.background = 'rgba(34, 197, 94, 0.1)';
                }
            }
            if (attended === 'Non') {
                row.classList.add('attended-no');
                // Ajouter une l√©g√®re surbrillance orange pour les places vendues
                if (competition) {
                    const currentBg = row.style.background;
                    row.style.background = `${currentBg}, rgba(251, 146, 60, 0.05)`;
                } else {
                    row.style.background = 'rgba(251, 146, 60, 0.1)';
                }
            }
        }

        function removeMatch(matchId) {
            document.getElementById(`match-${matchId}`).remove();
            updateStats();
            updateAnalysis();
            saveData(); // Sauvegarder apr√®s suppression
        }

        function updateStats() {
            const rows = document.querySelectorAll('#matchTable tbody tr');
            let totalRevenue = 0;
            let attendedCount = 0;
            let soldCount = 0;
            let lostCount = 0; // Places perdues
            let totalSalesAmount = 0;
            
            console.log('Nombre de lignes trouv√©es:', rows.length);
            
            rows.forEach((row, index) => {
                try {
                    const revenueElement = row.querySelector('td:nth-child(6)');
                    const attendedElement = row.querySelector('td:nth-child(5) select');
                    const priceElement = row.querySelector('td:nth-child(4) input');
                    
                    if (revenueElement && attendedElement && priceElement) {
                        const revenue = parseFloat(revenueElement.textContent.replace('‚Ç¨', '').trim()) || 0;
                        const attended = attendedElement.value;
                        const price = parseFloat(priceElement.value) || 0;
                        
                        console.log(`Ligne ${index + 1}:`, {
                            revenue,
                            attended,
                            price,
                            revenueText: revenueElement.textContent
                        });
                        
                        totalRevenue += revenue;
                        
                        if (attended === 'Oui') {
                            attendedCount++;
                            console.log('Match assist√© trouv√©');
                        } else if (attended === 'Non') {
                            if (price > 0) {
                                soldCount++;
                                totalSalesAmount += price;
                                console.log('Place vendue trouv√©e, prix:', price);
                            } else {
                                lostCount++;
                                console.log('Place perdue trouv√©e (prix = 0)');
                            }
                        }
                    } else {
                        console.log(`Ligne ${index + 1}: √©l√©ments manquants`, {
                            revenueElement: !!revenueElement,
                            attendedElement: !!attendedElement,
                            priceElement: !!priceElement
                        });
                    }
                } catch (e) {
                    console.log('Erreur ligne', index + 1, ':', e);
                }
            });
            
            const netResult = totalRevenue - 1680;
            const averagePrice = soldCount > 0 ? Math.round(totalSalesAmount / soldCount) : 0;
            
            console.log('R√©sultats finaux:', {
                totalRevenue,
                attendedCount,
                soldCount,
                lostCount,
                totalSalesAmount,
                averagePrice
            });
            
            // Mise √† jour des √©l√©ments
            const elements = {
                'totalRevenue': totalRevenue + '‚Ç¨',
                'netResult': netResult + '‚Ç¨',
                'attendedMatches': attendedCount.toString(),
                'soldMatches': soldCount.toString(),
                'lostMatches': lostCount.toString(),
                'averagePrice': averagePrice + '‚Ç¨'
            };
            
            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = elements[id];
                    console.log(`Mise √† jour ${id}:`, elements[id]);
                    
                    if (id === 'netResult') {
                        element.className = 'stat-value ' + (netResult >= 0 ? 'revenue-positive' : 'revenue-negative');
                    }
                } else {
                    console.log(`√âl√©ment ${id} introuvable !`);
                }
            });
        }

        function updateAnalysis() {
            const rows = document.querySelectorAll('#matchTable tbody tr');
            const totalMatches = rows.length;
            
            if (totalMatches === 0) {
                document.getElementById('analysis').innerHTML = '<p>Ajoutez des matchs pour voir l\'analyse d√©taill√©e de votre abonnement.</p>';
                return;
            }
            
            const totalRevenue = parseFloat(document.getElementById('totalRevenue').textContent.replace('‚Ç¨', '')) || 0;
            const netResult = totalRevenue - 1680;
            const attendedCount = parseInt(document.getElementById('attendedMatches').textContent) || 0;
            const soldCount = parseInt(document.getElementById('soldMatches').textContent) || 0;
            const lostCount = parseInt(document.getElementById('lostMatches').textContent) || 0;
            const averagePrice = parseInt(document.getElementById('averagePrice').textContent.replace('‚Ç¨', '')) || 0;
            
            const costPerAttendedMatch = attendedCount > 0 ? Math.round((1680 - totalRevenue) / attendedCount) : 0;
            const profitabilityRate = Math.round((totalRevenue / 1680) * 100);
            
            // R√©partition par comp√©tition
            let ligue1Count = 0, ligue1Attended = 0, ligue1Sold = 0, ligue1Lost = 0;
            let uclCount = 0, uclAttended = 0, uclSold = 0, uclLost = 0;
            let coupeCount = 0, coupeAttended = 0, coupeSold = 0, coupeLost = 0;
            
            rows.forEach(row => {
                try {
                    const competitionSelect = row.querySelector('td:nth-child(3) select');
                    const attendedSelect = row.querySelector('td:nth-child(5) select');
                    const priceInput = row.querySelector('td:nth-child(4) input');
                    
                    if (competitionSelect && attendedSelect && priceInput) {
                        const competition = competitionSelect.value;
                        const attended = attendedSelect.value;
                        const price = parseFloat(priceInput.value) || 0;
                        
                        if (competition === 'Ligue 1') {
                            ligue1Count++;
                            if (attended === 'Oui') ligue1Attended++;
                            else if (attended === 'Non') {
                                if (price > 0) ligue1Sold++;
                                else ligue1Lost++;
                            }
                        } else if (competition === 'Ligue des Champions') {
                            uclCount++;
                            if (attended === 'Oui') uclAttended++;
                            else if (attended === 'Non') {
                                if (price > 0) uclSold++;
                                else uclLost++;
                            }
                        } else if (competition === 'Coupe de France') {
                            coupeCount++;
                            if (attended === 'Oui') coupeAttended++;
                            else if (attended === 'Non') {
                                if (price > 0) coupeSold++;
                                else coupeLost++;
                            }
                        }
                    }
                } catch (e) {
                    console.log('Erreur analyse ligne:', e);
                }
            });
            
            let analysis = `
                <p><strong>üìà Rentabilit√©:</strong> ${profitabilityRate}% (${totalRevenue}‚Ç¨ / 1680‚Ç¨)</p>
                <p><strong>üí∞ R√©sultat net:</strong> ${netResult >= 0 ? '+' : ''}${netResult}‚Ç¨</p>
                <p><strong>üé´ Co√ªt par match assist√©:</strong> ${costPerAttendedMatch > 0 ? costPerAttendedMatch : 0}‚Ç¨</p>
                <p><strong>üìä R√©partition:</strong> ${attendedCount} assist√©s, ${soldCount} vendues, ${lostCount} perdues</p>
                <p><strong>üíµ Prix moyen de vente:</strong> ${averagePrice}‚Ç¨</p>
                
                <p style="margin-top: 15px;"><strong>üèÜ Par comp√©tition:</strong></p>
                <p style="margin-left: 10px;">üå∏ <strong>Ligue 1:</strong> ${ligue1Count} matchs (${ligue1Attended} assist√©s, ${ligue1Sold} vendus, ${ligue1Lost} perdus)</p>
                <p style="margin-left: 10px;">üîµ <strong>Ligue des Champions:</strong> ${uclCount} matchs (${uclAttended} assist√©s, ${uclSold} vendus, ${uclLost} perdus)</p>
                <p style="margin-left: 10px;">üî¥ <strong>Coupe de France:</strong> ${coupeCount} matchs (${coupeAttended} assist√©s, ${coupeSold} vendus, ${coupeLost} perdus)</p>
            `;
            
            if (netResult >= 0) {
                analysis += '<p style="color: #059669; margin-top: 15px;"><strong>üéâ F√©licitations ! Votre abonnement est rentabilis√©.</strong></p>';
            } else {
                const remainingAmount = Math.abs(netResult);
                const additionalSalesNeeded = averagePrice > 0 ? Math.ceil(remainingAmount / averagePrice) : 0;
                
                analysis += `<p style="color: #dc2626; margin-top: 15px;"><strong>üìä Pour rentabiliser compl√®tement :</strong></p>`;
                analysis += `<p>‚Ä¢ Montant restant √† r√©cup√©rer: <strong>${remainingAmount}‚Ç¨</strong></p>`;
                if (averagePrice > 0) {
                    analysis += `<p>‚Ä¢ Au prix moyen de vos ventes (${averagePrice}‚Ç¨), il faudrait vendre <strong>${additionalSalesNeeded} places suppl√©mentaires</strong></p>`;
                }
                analysis += `<p>‚Ä¢ Ou vendre une place √† <strong>${remainingAmount}‚Ç¨</strong> pour rentabiliser d'un coup</p>`;
            }
            
            console.log('Analysis HTML:', analysis);
            document.getElementById('analysis').innerHTML = analysis;
        }

        // Ajouter quelques matchs d'exemple
        window.onload = function() {
            // Charger les donn√©es sauvegard√©es au d√©marrage
            loadData();
            
            // Force une mise √† jour initiale des stats
            setTimeout(() => {
                updateStats();
                updateAnalysis();
            }, 500);
        };

        // Fonctions d'export/import
        function exportData() {
            const data = localStorage.getItem('psg_subscription_data');
            if (!data) {
                alert('Aucune donn√©e √† exporter !');
                return;
            }
            
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `suivi_psg_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const notification = document.createElement('div');
            notification.innerHTML = 'üì§ Donn√©es export√©es !';
            notification.className = 'notification';
            notification.style.background = '#004170';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 1500);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    localStorage.setItem('psg_subscription_data', JSON.stringify(data));
                    location.reload(); // Recharger la page pour appliquer les donn√©es
                } catch (error) {
                    alert('Erreur lors de l\'import des donn√©es !');
                }
            };
            reader.readAsText(file);
        }

        function clearData() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ?')) {
                localStorage.removeItem('psg_subscription_data');
                location.reload();
            }
        }
    </script>
</body>
</html>
